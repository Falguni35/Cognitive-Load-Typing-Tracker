<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cognitive Load Typing Tracker</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-tertiary: #334155;
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --accent: #3b82f6;
        --accent-hover: #2563eb;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --border: #475569;
      }

      [data-theme="light"] {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #e2e8f0;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --border: #cbd5e1;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: var(--bg-secondary);
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 24px;
        border: 1px solid var(--border);
        position: relative;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: start;
        gap: 20px;
        flex-wrap: wrap;
      }

      .header-text h1 {
        font-size: 28px;
        margin-bottom: 8px;
        color: var(--accent);
      }

      .header-text p {
        color: var(--text-secondary);
        margin-bottom: 12px;
      }

      .help-tip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        color: var(--text-secondary);
        padding: 6px 12px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        cursor: help;
      }

      .help-tip kbd {
        background: var(--bg-primary);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        border: 1px solid var(--border);
        font-size: 12px;
      }

      .theme-toggle {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .theme-toggle:hover {
        background: var(--accent);
        color: white;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 24px;
        margin-bottom: 24px;
      }

      .typing-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .typing-test-container {
        background: var(--bg-secondary);
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        position: relative;
      }

      .target-text {
        font-family: "Courier New", monospace;
        font-size: 18px;
        line-height: 1.8;
        margin-bottom: 16px;
        padding: 16px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        letter-spacing: 0.5px;
        user-select: none;
        min-height: 120px;
      }

      .target-char {
        position: relative;
        transition: all 0.15s ease;
      }

      .target-char.correct {
        color: var(--success);
        font-weight: 600;
      }

      .target-char.incorrect {
        color: var(--danger);
        font-weight: 600;
        background: rgba(239, 68, 68, 0.15);
        border-radius: 2px;
      }

      .target-char.current {
        background: var(--accent);
        color: white;
        border-radius: 2px;
        animation: blink 1s ease-in-out infinite;
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      .typing-input {
        background: var(--bg-primary);
        border: 2px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        font-size: 18px;
        font-family: "Courier New", monospace;
        color: var(--text-primary);
        width: 100%;
        min-height: 80px;
        resize: vertical;
        transition: border-color 0.2s;
      }

      .typing-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .typing-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .test-controls {
        display: flex;
        gap: 12px;
        margin-top: 16px;
      }

      .accuracy-display {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        font-size: 14px;
      }

      .accuracy-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .accuracy-label {
        color: var(--text-secondary);
        font-size: 12px;
      }

      .accuracy-value {
        font-weight: 600;
        font-size: 16px;
      }

      .accuracy-value.success {
        color: var(--success);
      }

      .accuracy-value.danger {
        color: var(--danger);
      }

      .timeline-container {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
      }

      .timeline-container h3 {
        font-size: 14px;
        margin-bottom: 12px;
        color: var(--text-secondary);
      }

      .timeline-bar {
        height: 40px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        position: relative;
        overflow: hidden;
      }

      .timeline-marker {
        position: absolute;
        width: 3px;
        height: 100%;
        background: var(--danger);
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .timeline-marker:hover {
        opacity: 1;
        width: 4px;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .gauge-container {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
        text-align: center;
      }

      .gauge-container h2 {
        font-size: 18px;
        margin-bottom: 20px;
      }

      .gauge {
        width: 180px;
        height: 180px;
        margin: 0 auto 16px;
        position: relative;
      }

      .gauge-circle {
        transform: rotate(-90deg);
      }

      .gauge-bg {
        fill: none;
        stroke: var(--bg-tertiary);
        stroke-width: 12;
      }

      .gauge-fill {
        fill: none;
        stroke: var(--accent);
        stroke-width: 12;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease, stroke 0.5s ease;
      }

      .gauge-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        font-weight: bold;
      }

      .gauge-label {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: 8px;
      }

      .stats-panel,
      .prediction-box {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
      }

      .stats-panel h3,
      .prediction-box h3 {
        font-size: 16px;
        margin-bottom: 16px;
        color: var(--accent);
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }

      .stat-row:last-child {
        border-bottom: none;
      }

      .stat-label {
        color: var(--text-secondary);
        font-size: 14px;
      }

      .stat-value {
        font-weight: 600;
        font-size: 14px;
      }

      .prediction-content {
        text-align: center;
      }

      .load-label {
        font-size: 24px;
        font-weight: bold;
        margin: 16px 0;
        padding: 12px;
        border-radius: 8px;
        background: var(--bg-tertiary);
      }

      .load-label.low {
        color: var(--success);
      }
      .load-label.medium {
        color: var(--warning);
      }
      .load-label.high {
        color: var(--danger);
      }

      .confidence {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 16px;
      }

      .tip {
        background: var(--bg-tertiary);
        padding: 12px;
        border-radius: 6px;
        font-size: 13px;
        line-height: 1.5;
        color: var(--text-secondary);
      }

      .controls {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
      }

      .controls h3 {
        font-size: 16px;
        margin-bottom: 16px;
        color: var(--accent);
      }

      .control-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 16px;
      }

      .label-selector {
        display: flex;
        gap: 8px;
      }

      .label-btn {
        flex: 1;
        padding: 10px 16px;
        border: 2px solid var(--border);
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .label-btn:hover {
        transform: translateY(-1px);
      }

      .label-btn.active {
        border-color: var(--accent);
        background: var(--accent);
        color: white;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-primary:hover {
        background: var(--accent-hover);
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border);
      }

      .btn-secondary:hover {
        background: var(--border);
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .btn-danger:hover {
        opacity: 0.9;
      }

      .history-section {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
      }

      .history-section h3 {
        font-size: 16px;
        margin-bottom: 16px;
        color: var(--accent);
      }

      .history-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .history-list::-webkit-scrollbar {
        width: 8px;
      }

      .history-list::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
        border-radius: 4px;
      }

      .history-list::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }

      .history-item {
        background: var(--bg-tertiary);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
      }

      .history-item:hover {
        border-color: var(--accent);
        transform: translateX(4px);
      }

      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .history-label {
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
      }

      .history-label.low {
        background: var(--success);
        color: white;
      }
      .history-label.medium {
        background: var(--warning);
        color: white;
      }
      .history-label.high {
        background: var(--danger);
        color: white;
      }

      .history-time {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .history-preview {
        font-size: 13px;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .shortcuts {
        background: var(--bg-tertiary);
        padding: 12px;
        border-radius: 6px;
        margin-top: 16px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .shortcuts kbd {
        background: var(--bg-primary);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        border: 1px solid var(--border);
      }

      @media (max-width: 1024px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .typing-indicator {
        animation: pulse 1.5s ease-in-out infinite;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="header-text">
            <h1>üß† Cognitive Load Typing Tracker</h1>
            <p>
              Analyze your typing patterns to understand cognitive load in
              real-time
            </p>
            <div
              class="help-tip"
              title="Type the sentence shown above. The app measures your typing speed, pauses, backspaces, and patterns to estimate cognitive load."
            >
              üí°
              <span>Type the sentence ‚Ä¢ Press <kbd>?</kbd> for shortcuts</span>
            </div>
          </div>
          <button
            class="theme-toggle"
            onclick="toggleTheme()"
            aria-label="Toggle theme"
          >
            üåì Toggle Theme
          </button>
        </div>
      </header>

      <div class="main-grid">
        <div class="typing-section">
          <div class="typing-test-container">
            <div class="target-text" id="targetText"></div>
            <textarea
              class="typing-input"
              id="typingInput"
              placeholder="Type the text above..."
              aria-label="Typing input area"
            ></textarea>
            <div
              class="accuracy-display"
              id="accuracyDisplay"
              style="display: none"
            >
              <div class="accuracy-stat">
                <span class="accuracy-label">Accuracy</span>
                <span class="accuracy-value success" id="accuracyPercent"
                  >100%</span
                >
              </div>
              <div class="accuracy-stat">
                <span class="accuracy-label">Correct</span>
                <span class="accuracy-value success" id="correctCount">0</span>
              </div>
              <div class="accuracy-stat">
                <span class="accuracy-label">Incorrect</span>
                <span class="accuracy-value danger" id="incorrectCount">0</span>
              </div>
              <div class="accuracy-stat">
                <span class="accuracy-label">Progress</span>
                <span class="accuracy-value" id="progressCount">0/0</span>
              </div>
            </div>
            <div class="test-controls">
              <button
                class="btn btn-primary"
                onclick="completeTest()"
                id="completeBtn"
              >
                ‚úÖ Complete Test
              </button>
              <button class="btn btn-secondary" onclick="resetTest()">
                üîÑ New Sentence
              </button>
              <button
                class="btn btn-secondary"
                onclick="window.location.href='mental.html'"
              >
                üß†Mental Test
              </button>
            </div>
          </div>

          <div class="timeline-container">
            <h3>üìä Backspace Timeline</h3>
            <div class="timeline-bar" id="timeline"></div>
          </div>
        </div>

        <div class="sidebar">
          <div class="gauge-container">
            <h2>Brain Load Meter</h2>
            <div class="gauge">
              <svg class="gauge-circle" viewBox="0 0 200 200">
                <circle class="gauge-bg" cx="100" cy="100" r="80"></circle>
                <circle
                  class="gauge-fill"
                  id="gaugeFill"
                  cx="100"
                  cy="100"
                  r="80"
                  stroke-dasharray="502.4"
                  stroke-dashoffset="502.4"
                ></circle>
              </svg>
              <div class="gauge-text" id="gaugeText">--</div>
            </div>
            <div class="gauge-label" id="gaugeLabel">Waiting for input...</div>
          </div>

          <div class="stats-panel">
            <h3>üìà Real-time Stats</h3>
            <div class="stat-row">
              <span class="stat-label">Typing Speed</span>
              <span class="stat-value" id="statSpeed">0 chars/s</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Avg Key Interval</span>
              <span class="stat-value" id="statInterval">0 ms</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Pauses (>300ms)</span>
              <span class="stat-value" id="statPause300">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Pauses (>500ms)</span>
              <span class="stat-value" id="statPause500">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Backspaces</span>
              <span class="stat-value" id="statBackspace">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Max Burst Length</span>
              <span class="stat-value" id="statBurst">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Edit Ratio</span>
              <span class="stat-value" id="statEditRatio">0%</span>
            </div>
          </div>

          <div class="prediction-box">
            <h3>üéØ Prediction</h3>
            <div class="prediction-content">
              <div class="load-label" id="predictionLabel">LOW</div>
              <div class="confidence" id="confidence">Confidence: --</div>
              <div class="tip" id="tip">
                Start typing to see predictions and tips!
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <h3>‚öôÔ∏è Controls & Dataset</h3>
        <div class="control-group">
          <div style="flex: 1">
            <label
              style="
                display: block;
                margin-bottom: 8px;
                font-size: 14px;
                color: var(--text-secondary);
              "
              >Label for Dataset:</label
            >
            <div class="label-selector">
              <button
                class="label-btn active"
                data-label="low"
                onclick="selectLabel('low')"
              >
                Low
              </button>
              <button
                class="label-btn"
                data-label="medium"
                onclick="selectLabel('medium')"
              >
                Medium
              </button>
              <button
                class="label-btn"
                data-label="high"
                onclick="selectLabel('high')"
              >
                High
              </button>
            </div>
          </div>
        </div>
        <div class="control-group">
          <button class="btn btn-primary" onclick="saveLog()">
            üíæ Save Log (S)
          </button>
          <button class="btn btn-secondary" onclick="downloadJSON()">
            üì• Download JSON
          </button>
          <button class="btn btn-secondary" onclick="downloadCSV()">
            üì• Download CSV
          </button>
          <button class="btn btn-danger" onclick="clearSession()">
            üóëÔ∏è Clear (C)
          </button>
        </div>
        <div class="shortcuts">
          <strong>Keyboard Shortcuts:</strong>
          <kbd>S</kbd> Save log ‚Ä¢ <kbd>C</kbd> Clear area ‚Ä¢ <kbd>T</kbd> Toggle
          theme
        </div>
      </div>

      <div class="history-section">
        <h3>üìö Session History (<span id="historyCount">0</span>)</h3>
        <div class="history-list" id="historyList">
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No saved logs yet. Start typing and save your first session!</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Sample sentences for typing test
      const sampleSentences = [
        "The quick brown fox jumps over the lazy dog near the riverbank.",
        "Programming requires patience, practice, and problem-solving skills.",
        "Artificial intelligence is transforming the way we work and live.",
        "Climate change poses significant challenges for future generations.",
        "Reading books expands your vocabulary and enhances critical thinking.",
        "Regular exercise improves both physical and mental health significantly.",
        "Technology has revolutionized communication across the entire globe.",
        "Learning a new language opens doors to different cultures and opportunities.",
        "Time management is crucial for achieving success in any endeavor.",
        "Creative thinking helps solve complex problems in innovative ways.",
        "Healthy eating habits contribute to overall wellness and longevity.",
        "Teamwork and collaboration are essential for organizational success.",
        "Scientific research advances our understanding of the natural world.",
        "Music has the power to evoke emotions and memories instantly.",
        "Sustainable practices are necessary to protect our environment today.",
      ];

      // State management
      let typingData = {
        keystrokes: [],
        backspaces: [],
        text: "",
        startTime: null,
        selectedLabel: "low",
        targetText: "",
        correctChars: 0,
        incorrectChars: 0,
      };

      let sessionHistory = [];

      // Initialize
      function init() {
        const savedTheme = localStorage.getItem("theme") || "dark";
        document.documentElement.setAttribute("data-theme", savedTheme);
        loadHistory();
        setupEventListeners();
        resetTest();
      }

      function resetTest() {
        // Select random sentence
        const randomSentence =
          sampleSentences[Math.floor(Math.random() * sampleSentences.length)];
        typingData.targetText = randomSentence;
        typingData.text = "";
        typingData.keystrokes = [];
        typingData.backspaces = [];
        typingData.startTime = null;
        typingData.correctChars = 0;
        typingData.incorrectChars = 0;

        // Render target text
        const targetEl = document.getElementById("targetText");
        targetEl.innerHTML = randomSentence
          .split("")
          .map(
            (char, idx) =>
              `<span class="target-char" data-index="${idx}">${
                char === " " ? "&nbsp;" : char
              }</span>`
          )
          .join("");

        // Clear input
        const input = document.getElementById("typingInput");
        input.value = "";
        input.disabled = false;
        input.focus();

        // Hide accuracy display
        document.getElementById("accuracyDisplay").style.display = "none";

        // Reset gauge and stats
        document.getElementById("gaugeText").textContent = "--";
        document.getElementById("gaugeLabel").textContent =
          "Waiting for input...";
        document.getElementById("gaugeFill").style.strokeDashoffset = "502.4";
        document.getElementById("timeline").innerHTML = "";

        // Reset stats
        document.getElementById("statSpeed").textContent = "0 chars/s";
        document.getElementById("statInterval").textContent = "0 ms";
        document.getElementById("statPause300").textContent = "0";
        document.getElementById("statPause500").textContent = "0";
        document.getElementById("statBackspace").textContent = "0";
        document.getElementById("statBurst").textContent = "0";
        document.getElementById("statEditRatio").textContent = "0%";
      }

      function setupEventListeners() {
        const input = document.getElementById("typingInput");

        input.addEventListener("keydown", (e) => {
          const now = Date.now();
          if (!typingData.startTime) typingData.startTime = now;

          const keystroke = {
            key: e.key,
            time: now,
            isBackspace: e.key === "Backspace",
            position: input.selectionStart,
          };

          typingData.keystrokes.push(keystroke);

          if (e.key === "Backspace") {
            typingData.backspaces.push({
              time: now,
              position: input.selectionStart,
            });
          }
        });

        input.addEventListener("input", () => {
          typingData.text = input.value;
          updateCharacterComparison();
          updateAnalysis();
        });

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if (e.target.id === "typingInput") return;

          if (e.key === "s" || e.key === "S") {
            e.preventDefault();
            saveLog();
          } else if (e.key === "c" || e.key === "C") {
            e.preventDefault();
            resetTest();
          } else if (e.key === "t" || e.key === "T") {
            e.preventDefault();
            toggleTheme();
          }
        });
      }

      function updateCharacterComparison() {
        const target = typingData.targetText;
        const typed = typingData.text;
        const targetChars = document.querySelectorAll(".target-char");

        let correct = 0;
        let incorrect = 0;

        targetChars.forEach((charEl, idx) => {
          charEl.classList.remove("correct", "incorrect", "current");

          if (idx < typed.length) {
            if (typed[idx] === target[idx]) {
              charEl.classList.add("correct");
              correct++;
            } else {
              charEl.classList.add("incorrect");
              incorrect++;
            }
          } else if (idx === typed.length) {
            charEl.classList.add("current");
          }
        });

        typingData.correctChars = correct;
        typingData.incorrectChars = incorrect;

        // Update accuracy display
        const accuracyDisplay = document.getElementById("accuracyDisplay");
        if (typed.length > 0) {
          accuracyDisplay.style.display = "flex";
          const total = correct + incorrect;
          const accuracy =
            total > 0 ? ((correct / total) * 100).toFixed(1) : 100;

          document.getElementById(
            "accuracyPercent"
          ).textContent = `${accuracy}%`;
          document.getElementById("correctCount").textContent = correct;
          document.getElementById("incorrectCount").textContent = incorrect;
          document.getElementById(
            "progressCount"
          ).textContent = `${typed.length}/${target.length}`;
        }
      }

      async function completeTest() {
        if (typingData.keystrokes.length === 0) {
          alert("Please type something before completing the test!");
          return;
        }

        const input = document.getElementById("typingInput");
        input.disabled = true;

        const stats = calculateStats();

        // Get ML prediction
        let mlResult;
        try {
          mlResult = await predictLoad(stats);
        } catch (error) {
          console.error("Prediction error:", error);
          mlResult = { level: "medium", confidence: 75 };
        }

        const load = {
          level: mlResult.level,
          confidence: mlResult.confidence,
          percentage:
            mlResult.level === "low"
              ? 30
              : mlResult.level === "medium"
              ? 60
              : 90,
        };

        // Calculate accuracy
        const accuracy =
          typingData.correctChars + typingData.incorrectChars > 0
            ? (
                (typingData.correctChars /
                  (typingData.correctChars + typingData.incorrectChars)) *
                100
              ).toFixed(1)
            : 0;

        const safeLevel = ["low", "medium", "high"].includes(load.level)
          ? load.level
          : "medium";

        const safeConfidence = isNaN(load.confidence)
          ? 50
          : Number(load.confidence).toFixed(1);

        // Store results for wellness page (don't clear - it removes typing history)
        localStorage.setItem("cognitiveLoad", safeLevel);
        localStorage.setItem("accuracy", Number(accuracy).toFixed(1));
        localStorage.setItem("speed", Number(stats.speed).toFixed(2));
        localStorage.setItem("confidence", safeConfidence);

        // Small delay to ensure localStorage is written before redirect
        setTimeout(() => {
          alert("Test completed! Redirecting to Mental Test page.");
          window.location.href = "mental.html";
        }, 100);
      }

      async function updateAnalysis() {
        if (typingData.keystrokes.length < 2) return;

        const stats = calculateStats();
        const mlResult = await predictLoad(stats);

        const load = {
          level: mlResult.level,
          confidence: mlResult.confidence,
          percentage:
            mlResult.level === "low"
              ? 30
              : mlResult.level === "medium"
              ? 60
              : 90,
        };

        updateStats(stats);
        updateGauge(load);
        updatePrediction(load, stats);
        updateTimeline();
      }

      function calculateStats() {
        const keystrokes = typingData.keystrokes;
        const textLength = typingData.text.length;
        const duration = (Date.now() - typingData.startTime) / 1000;

        // Intervals
        const intervals = [];
        for (let i = 1; i < keystrokes.length; i++) {
          intervals.push(keystrokes[i].time - keystrokes[i - 1].time);
        }

        const avgInterval =
          intervals.length > 0
            ? intervals.reduce((a, b) => a + b, 0) / intervals.length
            : 0;

        // Pauses
        const pause300 = intervals.filter((i) => i > 300).length;
        const pause500 = intervals.filter((i) => i > 500).length;

        // Burst length
        let maxBurst = 0;
        let currentBurst = 0;
        for (let i = 1; i < keystrokes.length; i++) {
          const interval = keystrokes[i].time - keystrokes[i - 1].time;
          if (interval < 200) {
            currentBurst++;
            maxBurst = Math.max(maxBurst, currentBurst);
          } else {
            currentBurst = 0;
          }
        }

        // Edit ratio
        const backspaceCount = typingData.backspaces.length;
        const totalKeys = keystrokes.length;
        const editRatio =
          totalKeys > 0 ? (backspaceCount / totalKeys) * 100 : 0;

        // Typing speed
        const speed = duration > 0 ? textLength / duration : 0;

        return {
          speed: speed.toFixed(2),
          avgInterval: avgInterval.toFixed(0),
          pause300,
          pause500,
          backspaceCount,
          maxBurst,
          editRatio: editRatio.toFixed(1),
          duration: duration.toFixed(1),
        };
      }

      async function predictLoad(stats) {
        try {
          const response = await fetch("http://127.0.0.1:5000/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              speed: parseFloat(stats.speed),
              avgInterval: parseFloat(stats.avgInterval),
              pause300: stats.pause300,
              pause500: stats.pause500,
              backspaceCount: stats.backspaceCount,
              maxBurst: stats.maxBurst,
              editRatio: parseFloat(stats.editRatio),
              duration: parseFloat(stats.duration),
            }),
          });

          return await response.json();
        } catch (error) {
          console.error("Prediction API error:", error);
          return { level: "medium", confidence: 50 };
        }
      }

      function updateStats(stats) {
        document.getElementById(
          "statSpeed"
        ).textContent = `${stats.speed} chars/s`;
        document.getElementById(
          "statInterval"
        ).textContent = `${stats.avgInterval} ms`;
        document.getElementById("statPause300").textContent = stats.pause300;
        document.getElementById("statPause500").textContent = stats.pause500;
        document.getElementById("statBackspace").textContent =
          stats.backspaceCount;
        document.getElementById("statBurst").textContent = stats.maxBurst;
        document.getElementById(
          "statEditRatio"
        ).textContent = `${stats.editRatio}%`;
      }

      function updateGauge(load) {
        const fill = document.getElementById("gaugeFill");
        const text = document.getElementById("gaugeText");
        const label = document.getElementById("gaugeLabel");

        const circumference = 502.4;
        const offset = circumference - (load.percentage / 100) * circumference;

        fill.style.strokeDashoffset = offset;
        text.textContent = `${Math.round(load.percentage)}%`;
        label.textContent = `Load: ${load.level.toUpperCase()}`;

        // Color coding
        if (load.level === "low") {
          fill.style.stroke = "#10b981";
        } else if (load.level === "medium") {
          fill.style.stroke = "#f59e0b";
        } else {
          fill.style.stroke = "#ef4444";
        }
      }

      function updatePrediction(load, stats) {
        const labelEl = document.getElementById("predictionLabel");
        const confidenceEl = document.getElementById("confidence");
        const tipEl = document.getElementById("tip");

        labelEl.textContent = load.level.toUpperCase();
        labelEl.className = `load-label ${load.level}`;
        confidenceEl.textContent = `Confidence: ${load.confidence}%`;

        // Contextual tips
        const tips = {
          low: "Great flow! You're typing smoothly with minimal corrections. Keep it up!",
          medium:
            "Moderate cognitive load detected. Consider taking short breaks if needed.",
          high: "High cognitive load detected. Many pauses and corrections suggest complex thinking. Take a breather if helpful!",
          pending: "Complete the test to get your cognitive load prediction!",
        };

        tipEl.textContent = tips[load.level] || tips.pending;
      }

      function updateTimeline() {
        const timeline = document.getElementById("timeline");
        timeline.innerHTML = "";

        const textLength = typingData.text.length || 1;

        typingData.backspaces.forEach((bs) => {
          const marker = document.createElement("div");
          marker.className = "timeline-marker";
          marker.style.left = `${(bs.position / textLength) * 100}%`;
          marker.title = `Backspace at position ${bs.position}`;
          timeline.appendChild(marker);
        });
      }

      function selectLabel(label) {
        typingData.selectedLabel = label;
        document.querySelectorAll(".label-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.label === label);
        });
      }

      function saveLog() {
        if (typingData.keystrokes.length === 0) {
          alert("No data to save! Start typing first.");
          return;
        }

        const stats = calculateStats();
        const accuracy =
          typingData.correctChars + typingData.incorrectChars > 0
            ? (
                (typingData.correctChars /
                  (typingData.correctChars + typingData.incorrectChars)) *
                100
              ).toFixed(1)
            : 0;

        const log = {
          timestamp: new Date().toISOString(),
          label: typingData.selectedLabel,
          targetText: typingData.targetText,
          typedText: typingData.text,
          accuracy: parseFloat(accuracy),
          correctChars: typingData.correctChars,
          incorrectChars: typingData.incorrectChars,
          stats,
          keystrokes: typingData.keystrokes,
          backspaces: typingData.backspaces,
        };

        sessionHistory.unshift(log);
        saveHistory();
        renderHistory();
        alert(
          `Log saved!\n\nLabel: ${typingData.selectedLabel.toUpperCase()}\nAccuracy: ${accuracy}%`
        );
      }

      function clearSession() {
        if (!confirm("Clear current typing session and start new test?"))
          return;
        resetTest();
      }

      function downloadJSON() {
        if (sessionHistory.length === 0) {
          alert("No logs to download!");
          return;
        }

        const blob = new Blob([JSON.stringify(sessionHistory, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `typing-logs-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function downloadCSV() {
        if (sessionHistory.length === 0) {
          alert("No logs to download!");
          return;
        }

        const headers = [
          "timestamp",
          "label",
          "accuracy",
          "correctChars",
          "incorrectChars",
          "speed",
          "avgInterval",
          "pause300",
          "pause500",
          "backspaceCount",
          "maxBurst",
          "editRatio",
          "duration",
        ];

        const rows = sessionHistory.map((log) => [
          log.timestamp,
          log.label,
          log.accuracy || 0,
          log.correctChars || 0,
          log.incorrectChars || 0,
          log.stats.speed,
          log.stats.avgInterval,
          log.stats.pause300,
          log.stats.pause500,
          log.stats.backspaceCount,
          log.stats.maxBurst,
          log.stats.editRatio,
          log.stats.duration,
        ]);

        const csv = [headers, ...rows].map((row) => row.join(",")).join("\n");

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `typing-features-${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function saveHistory() {
        localStorage.setItem("typingHistory", JSON.stringify(sessionHistory));
      }

      function loadHistory() {
        const saved = localStorage.getItem("typingHistory");
        if (saved) {
          try {
            sessionHistory = JSON.parse(saved);
            renderHistory();
          } catch (e) {
            console.error("Failed to load history:", e);
          }
        }
      }

      function renderHistory() {
        const list = document.getElementById("historyList");
        const count = document.getElementById("historyCount");

        count.textContent = sessionHistory.length;

        if (sessionHistory.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìù</div>
              <p>No saved logs yet. Start typing and save your first session!</p>
            </div>
          `;
          return;
        }

        list.innerHTML = sessionHistory
          .map((log, index) => {
            const date = new Date(log.timestamp);
            const timeStr = date.toLocaleString();
            const preview =
              (log.typedText || log.text || "").substring(0, 60) +
              ((log.typedText || log.text || "").length > 60 ? "..." : "");
            const accuracy = log.accuracy ? `${log.accuracy}% acc` : "";

            return `
              <div class="history-item" onclick="loadLog(${index})">
                <div class="history-header">
                  <span class="history-label ${
                    log.label
                  }">${log.label.toUpperCase()}</span>
                  <span class="history-time">${timeStr} ${
              accuracy ? `‚Ä¢ ${accuracy}` : ""
            }</span>
                </div>
                <div class="history-preview">${preview || "(Empty text)"}</div>
              </div>
            `;
          })
          .join("");
      }

      function loadLog(index) {
        const log = sessionHistory[index];
        if (!log) return;

        if (
          !confirm(
            "Load this log into the typing area? Current content will be lost."
          )
        ) {
          return;
        }

        typingData.targetText = log.targetText || "";
        typingData.text = log.typedText || log.text || "";
        typingData.keystrokes = log.keystrokes || [];
        typingData.backspaces = log.backspaces || [];
        typingData.startTime =
          log.keystrokes && log.keystrokes.length > 0
            ? log.keystrokes[0].time
            : Date.now();
        typingData.selectedLabel = log.label;
        typingData.correctChars = log.correctChars || 0;
        typingData.incorrectChars = log.incorrectChars || 0;

        // Render target text
        if (typingData.targetText) {
          const targetEl = document.getElementById("targetText");
          targetEl.innerHTML = typingData.targetText
            .split("")
            .map(
              (char, idx) =>
                `<span class="target-char" data-index="${idx}">${
                  char === " " ? "&nbsp;" : char
                }</span>`
            )
            .join("");
        }

        // Set input value
        document.getElementById("typingInput").value = typingData.text;

        selectLabel(log.label);
        updateCharacterComparison();
        updateAnalysis();
      }

      function toggleTheme() {
        const current = document.documentElement.getAttribute("data-theme");
        const next = current === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("theme", next);
      }

      // Initialize on load
      init();
    </script>
  </body>
</html>
